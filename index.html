<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Swicy Rush â€” Demo</title>
<link href="https://fonts.googleapis.com/css2?family=Chewy&family=Luckiest+Guy&family=Fredoka+One&family=Baloo+2:wght@600&family=Bangers&family=Bubblegum+Sans&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">


<style>
  :root{
    --accent:#87ceeb;
    --pink:#ff4da6;
    --bg1: linear-gradient(135deg,#ffdde1,#ee9ca7);
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg1);-webkit-font-smoothing:antialiased;}
  body{display:flex;align-items:center;justify-content:center;overflow:hidden;}

  #mainMenu{
    position:relative; z-index:20;
    width:400px; height:600px;
    border-radius:18px;
    background:rgba(255,255,255,0.95);
    box-shadow:0 12px 30px rgba(0,0,0,0.18),0 -6px 12px rgba(255,255,255,0.6);
    display:flex;flex-direction:column;align-items:center;justify-content:flex-start;
    padding-top:28px; gap:18px;
  }
 #mainMenu {
  position: relative; 
  z-index: 20;
  width: 90vw;           /* use viewport width */
  max-width: 400px;      /* limit maximum size */
  height: 80vh;          /* relative to viewport height */
  max-height: 600px;     
  border-radius: 18px;
  background: rgba(255,255,255,0.95);
  box-shadow: 0 12px 30px rgba(0,0,0,0.18), 0 -6px 12px rgba(255,255,255,0.6);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding-top: 20px;
  gap: 16px;
}

#mainMenu h1, #mainMenu h2 {
  margin: 0;        /* scales with viewport width */
  line-height: 1.1;
  color: var(--pink);
  letter-spacing: 1px;
  text-align: center;
}

 .menuBtn{
  width:78%;
  padding:.7vw 0;
  border-radius:999px;
  border:0;
  background:var(--pink);
  color:white;
  font-weight:700;
  font-size:16px;
  cursor:pointer;
  outline:none;
  transition:transform .12s ease,background .12s;
  }
  .menuBtn:hover{background:#ff80c0;transform:translateY(-3px);}

@media (max-width: 350px) {
  #mainMenu {
    width: 95vw;
    height: 75vh;
    padding-top: 16px;
  }

  .menuBtn {
    font-size: 5vw;
    padding: 2.5vw 0;
  }

  #mainMenu h1, #mainMenu h2 {
    font-size: 10vw;
  }
}

.candy-text {
      font-size: 80px;
      color: #ff4da6;
      margin: 5px 0;
    }

    .candy-text span {
      display: inline-block;
      cursor: pointer;
      transition: color 0.3s ease, text-shadow 0.3s ease;
    }

    .candy-text span:hover {
      color: #ff1a75;
      text-shadow: 0 0 15px #ff99cc, 0 0 25px #ff4da6;
      animation: popBounce 0.4s ease;
    }

    @keyframes popBounce {
      0%   { transform: scale(1); }
      40%  { transform: scale(1.5); }
      60%  { transform: scale(0.9); }
      80%  { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    /* Font classes */
    .chewy    { font-family: 'Chewy', cursive; }
    .luckiest { font-family: 'Luckiest Guy', cursive; }
    .fredoka  { font-family: 'Fredoka One', cursive; }
    .baloo    { font-family: 'Baloo 2', cursive; }
    .bangers  { font-family: 'Bangers', cursive; }
    .bubble   { font-family: 'Bubblegum Sans', cursive; }




  #boardWrap{
    position:absolute;inset:36px;display:flex;align-items:center;justify-content:center;
  }
  #innerBoard{
    width:100%;height:100%;max-width:calc(100% - 40px);max-height:calc(100% - 40px);
    border-radius:14px; background:#e6e6e6;
    box-shadow:inset 0 10px 20px rgba(0,0,0,0.18),inset 0 -6px 12px rgba(0,0,0,0.08);
    display:grid;grid-template-columns: repeat(8,1fr);grid-template-rows: repeat(8,1fr); gap:6px;
    padding:8px; box-sizing:border-box;
  }

@keyframes glowPulse {
  0% { box-shadow: 0 0 10px 2px rgba(135, 206, 250, 0.6); }
  50% { box-shadow: 0 0 16px 4px rgba(135, 206, 250, 0.9); }
  100% { box-shadow: 0 0 10px 2px rgba(135, 206, 250, 0.6); }
}

@keyframes hoverPulse {
  0% { box-shadow: 0 0 6px 1px rgba(135, 206, 250, 0.4); }
  50% { box-shadow: 0 0 10px 2px rgba(135, 206, 250, 0.6); }
  100% { box-shadow: 0 0 6px 1px rgba(135, 206, 250, 0.4); }
}

.tile:hover {
  animation: hoverPulse 0.6s infinite ease-in-out;
}

.tile.selected {
  animation: glowPulse 1s infinite ease-in-out;
}

@keyframes subtleShake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-2px); }
  50% { transform: translateX(2px); }
  75% { transform: translateX(-1px); }
}

.tile.shake {
  animation: subtleShake 0.25s ease;
}

  .tile {
    background:white;
    position:relative; overflow:hidden;
    display:flex;align-items:center;justify-content:center;
    border-radius:10px; cursor:pointer; user-select:none;
    transition: transform .12s ease, box-shadow .12s ease;
  }
  .tileImg{
    width:100%;height:100%;border-radius:10px; object-fit:cover;
  }

  .tile:hover, .tile.selected { transform:scale(1.06); box-shadow: 0 0 12px 4px rgba(135, 206, 250, 0.6); }

  @keyframes matchPop {0%{transform:scale(1);opacity:1;}50%{transform:scale(1.2);opacity:.8;}100%{transform:scale(0);opacity:0;}}
  .tile.matching { animation: matchPop .4s ease forwards; }

  .tile.selected { box-shadow: 0 0 16px 6px rgba(135, 206, 250, 0.8); }	
  @keyframes shake{0%,100%{transform:translateX(0);}25%{transform:translateX(-4px);}50%{transform:translateX(4px);}75%{transform:translateX(-2px);}}

  .floating-score {
    position: absolute;
    font-weight: 800;
    color: var(--pink);
    font-size: 14px;
    pointer-events: none;
    animation: floatUp 0.8s ease forwards;
  }
  @keyframes floatUp {
    0% { transform: translateY(0); opacity: 1; }
    100% { transform: translateY(-28px); opacity: 0; }
  }

  #timerDisplay, #scoreDisplay { position:absolute; top:12px; font-weight:700; color:var(--pink); z-index:30; font-size:15px; }
  #timerDisplay { left:55px; }
  #scoreDisplay { right:60px; }
  #backButton { position:absolute; bottom:14px; left:55px; z-index:30; padding:8px 12px; border-radius:10px; border:0; background:var(--pink); color:white; font-weight:700; cursor:pointer; }
  #backButton:hover{background:#ff80c0;}
  
  #appWrapper {
  display: flex;
  flex-direction: column; /* stack vertically */
  align-items: center;
  gap: 20px;
  width: 90vw;
  max-width: 720px;
  padding: 20px 0;
}

  #gameContainer{
    display:none; position:relative; z-index:10;
    width:85vmin; max-width:704px; height:85vmin; max-height:667px;
    border-radius:20px; background:#fff;
    box-shadow:0 12px 30px rgba(0,0,0,0.2),0 -6px 14px rgba(255,255,255,0.8);
    overflow:hidden;
  }

/* Music Player */

#musicPlayerBox {
	display:none;
	width:70vmin;
    max-width: 580px;
	border-radius:20px; background:#fff;
    box-shadow:0 12px 30px rgba(0,0,0,0.2),0 -6px 14px rgba(255,255,255,0.8);
    overflow:visible;
  }
  .btn-candy {
      border: none;
      border-radius: 50% !important;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      background: linear-gradient(135deg,#ff6ec7,#ff9a9e);
      color: white;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn-candy:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 12px rgba(0,0,0,0.25);
    }
    .btn-candy:active {
      transform: scale(0.95);
    }
 
  .progress-bar {
    transition: width 0.2s linear;
  }
	.music-box {
      width: 100%;
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      text-align: center;
    }
    .progress {
      height: 8px;
      margin: 12px 0;
    }
    .btn-circle {
      border-radius: 50% !important;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    .dropup .dropdown-menu {
      max-height: 180px;
      overflow-y: auto;
    }
	
	/* Candy Volume Slider */
#volumeSlider {
  -webkit-appearance: none;
  width: 100%;
  height: 8px;
  border-radius: 999px;
  background: linear-gradient(90deg, #ff4da6, #87ceeb);
  outline: none;
  transition: box-shadow 0.2s ease;
}

#volumeSlider:hover {
  box-shadow: 0 0 10px rgba(255, 77, 166, 0.6),
              0 0 10px rgba(135, 206, 235, 0.6);
}

/* Thumb (the draggable knob) */
#volumeSlider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: white;
  border: 2px solid #ff4da6;
  cursor: pointer;
  transition: transform 0.15s ease, background 0.2s ease;
}

#volumeSlider::-webkit-slider-thumb:hover {
  background: #ff4da6;
  transform: scale(1.2);
}

#volumeSlider::-moz-range-thumb {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: white;
  border: 2px solid #ff4da6;
  cursor: pointer;
  transition: transform 0.15s ease, background 0.2s ease;
}

#volumeSlider::-moz-range-thumb:hover {
  background: #ff4da6;
  transform: scale(1.2);
}
#songTitle {
  width: 100%;
}

.candy-animation {
  display: flex;
  gap: 10px;
}

.candy {
  font-size: 28px;
  display: inline-block;
  animation: bounceCandy 1s infinite ease-in-out;
}

.candy-img {
  width: 50px;   /* updated size */
  height: 50px;  /* updated size */
}

.candy:nth-child(2) { animation-delay: 0.2s; }
.candy:nth-child(3) { animation-delay: 0.4s; }

@keyframes bounceCandy {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-12px) rotate(-10deg); }
}
#mechanicsModal .modal-dialog {
  max-width: 800px; /* adjust width as needed */
  width: 90%;       /* responsive for smaller screens */
}

#timerDisplay, #scoreDisplay, #movesDisplay {
  font-size: 22px;  /* increase from 15px */
  font-weight: 800; /* keep it bold */
  color: var(--pink);
  z-index: 30;
  text-align: center;
}


.floating-score {
  position: absolute;
  font-weight: 800;
  color: var(--pink);
  font-size: 20px;         /* bigger for visibility */
  pointer-events: none;
  animation: floatUp 0.8s ease forwards;
  text-shadow: 0 0 6px #fff, 0 0 10px #ff4da6;
}

@keyframes floatUp {
  0% { transform: translateY(0) scale(1); opacity: 1; }
  50% { transform: translateY(-20px) scale(1.3); opacity: 1; }
  100% { transform: translateY(-40px) scale(1); opacity: 0; }
}

#shuffleOverlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  backdrop-filter: blur(6px); /* blur the innerBoard */
  background: rgba(255,255,255,0.5); /* semi-transparent overlay */
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--pink);
  z-index: 50;
  border-radius: 14px;
  text-align: center;
  padding: 10px;
  opacity: 0;
  pointer-events: none; /* don't block clicks */
  transition: opacity 0.3s ease;
}
  
</style>
</head>
<body>
<div id="appWrapper">
<section id="mainMenu" aria-label="Main menu">
  <h2 class="candy-text bangers">
    <span>S</span><span>w</span><span>i</span><span>c</span><span>y</span> <span>R</span><span>u</span><span>s</span><span>h</span>
  </h2>
  
  <button id="classicBtn" class="menuBtn">Classic</button>
  <button id="hurryBtn" class="menuBtn">Hurry Hurry</button>
  <button id="dizzyBtn" class="menuBtn">Dizzy Dizzy</button>
  <button id="swishBtn" class="menuBtn">Swish and Match</button>
	<br>
  <button id="mechanicsBtn" class="menuBtn">Mechanics</button>
  <button id="leaderBtn" class="menuBtn">Leaderboard</button>
  <b>Demo Version</b>
  
</section>


<div class="modal fade" id="mechanicsModal" tabindex="-1" aria-labelledby="mechanicsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius:16px;">
      <div class="modal-header">
        <h5 class="modal-title" id="mechanicsModalLabel">Game Mechanics</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
		<div class="candy-animation d-flex justify-content-center mb-3">
			<img src="images/candy1.png" class="candy-img" alt="Candy 1">
			<img src="images/candy2.png" class="candy-img" alt="Candy 2">
			<img src="images/candy3.png" class="candy-img" alt="Candy 3">
			<img src="images/candy4.png" class="candy-img" alt="Candy 4">
			<img src="images/candy5.png" class="candy-img" alt="Candy 5">
			<img src="images/candy6.png" class="candy-img" alt="Candy 6">
			<img src="images/candy7.png" class="candy-img" alt="Candy 7">
			<img src="images/candy8.png" class="candy-img" alt="Candy 8">
		</div>
        <p><strong>Classic:</strong> Match candies at your own pace.</p>
        <p><strong>Hurry Hurry:</strong> Score as much as you can before time runs out!</p>
        <p><strong>Dizzy Dizzy:</strong> Candies randomly shuffle, stay sharp!</p>
        <p><strong>Swish and Match:</strong> Match candies and collect bonus candies <img src="images/bonuscandy.png" class="candy-img" alt="Candy 9"> to earn extra moves.</p>
      
		
		<p><strong>Developed By:</strong>https://x.com/BaN4N4000</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>



<section id="gameContainer" aria-hidden="true">
  <div id="timerDisplay">Time: âˆž</div>
  <div id="scoreDisplay">Score: 0</div>
   <div id="boardWrap">
    <div id="innerBoard" role="grid" aria-label="Game board"></div>
	<div id="shuffleOverlay">No more Tiles to Match!<br>Shuffling...</div>
	
  </div>
  <button id="backButton">Back</button>
</section>
<section>

<div id="musicPlayerBox" class="container">
  <div class="music-box">
  <h4 id="songTitle">Select a Song</h4>
  
  <audio id="audioPlayer" preload="auto"></audio>
  
  <!-- Progress bar -->
  <div class="progress">
    <div id="progressBar" class="progress-bar bg-danger" style="width: 0%;"></div>
  </div>

<div class="d-flex justify-content-between align-items-center my-2"> 
 
 <div style="width:150px;" class="text-start">
    <div class="dropup">
      <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
        Song List
      </button>
      <ul class="dropdown-menu" id="songList"></ul>
    </div>
  </div>
  <!-- Controls -->
  <div class="d-flex justify-content-center gap-3 my-2">
    <button class="btn-candy" id="prevBtn"><i class="bi bi-skip-backward-fill"></i></button>
    <button class="btn-candy" id="playBtn"><i class="bi bi-play-fill"></i></button>
    <button class="btn-candy" id="nextBtn"><i class="bi bi-skip-forward-fill"></i></button>
  </div>
 
  <div class="d-flex align-items-center ms-3" style="width:150px;">
    <i class="bi bi-volume-down me-1"></i>
    <input type="range" id="volumeSlider" min="0" max="100" value="70" class="flex-grow-1">
    <i class="bi bi-volume-up ms-1"></i>
  </div>
</div>
 
 
  <!-- Dropup list -->
  
  
</div>

</div>

</section>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>

//Possible Moves checker

function hasPossibleMoves() {
  for (let r = 0; r < ROWS; r++) {
    for (let c = 0; c < COLS; c++) {
      const val = board[r][c];

      // Check swap with right neighbor
      if (c < COLS - 1) {
        [board[r][c], board[r][c + 1]] = [board[r][c + 1], board[r][c]];
        if (findAllMatches().length > 0) {
          [board[r][c], board[r][c + 1]] = [board[r][c + 1], board[r][c]];
          return true;
        }
        [board[r][c], board[r][c + 1]] = [board[r][c + 1], board[r][c]];
      }

      // Check swap with bottom neighbor
      if (r < ROWS - 1) {
        [board[r][c], board[r + 1][c]] = [board[r + 1][c], board[r][c]];
        if (findAllMatches().length > 0) {
          [board[r][c], board[r + 1][c]] = [board[r + 1][c], board[r][c]];
          return true;
        }
        [board[r][c], board[r + 1][c]] = [board[r + 1][c], board[r][c]];
      }
    }
  }
  return false;
}

//Tile Shuffler
function shuffleBoard() {
  // Flatten board, shuffle array, then rebuild 2D board
  const flat = board.flat();
  for (let i = flat.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [flat[i], flat[j]] = [flat[j], flat[i]];
  }

  for (let r = 0; r < ROWS; r++) {
    for (let c = 0; c < COLS; c++) {
      board[r][c] = flat[r * COLS + c];
    }
  }

  renderWholeBoard();
}

function showShuffleOverlay(duration = 1000) {
  const overlay = document.getElementById('shuffleOverlay');
  overlay.style.opacity = 1;

  setTimeout(() => {
    overlay.style.opacity = 0;
  }, duration);
}


const mechanicsBtn = document.getElementById("mechanicsBtn");
const mechanicsModal = new bootstrap.Modal(document.getElementById('mechanicsModal'));

mechanicsBtn.addEventListener("click", () => {
  mechanicsModal.show();
});


const ROWS = 8, COLS = 8;
const IMAGE_PREFIX = 'images/candy';
const BONUS_IMAGE = 'images/bonuscandy.png';
const bonusSound = new Audio("kwengkweng.mp3");
bonusSound.volume = 0.7; // adjust if too loud


let board = [], score = 0, firstSelection = null, dragSource = null;
let mode = null, movesLeft = 0, timerValue = 0;
let timerInterval = null, dizzyInterval = null;

const mainMenu = document.getElementById('mainMenu');
const gameContainer = document.getElementById('gameContainer');
const innerBoard = document.getElementById('innerBoard');
const scoreDisplay = document.getElementById('scoreDisplay');
const timerDisplay = document.getElementById('timerDisplay');

function randInt(min, max){ return Math.floor(Math.random() * (max - min + 1)) + min; }
function randomCandyValue(){ return (mode === 'Swish and Match') ? randInt(1, 9) : randInt(1, 8); }

function createTileElement(r, c, val){
  const tile = document.createElement('div');
  tile.className = 'tile';
  tile.dataset.r = r; tile.dataset.c = c;
  tile.draggable = true;

  const img = document.createElement('img');
  img.className = 'tileImg';
  img.src = (val === 9) ? BONUS_IMAGE : `${IMAGE_PREFIX}${val}.png`;
  tile.appendChild(img);

  tile.addEventListener('click', () => onTileClick(r, c));
  tile.addEventListener('dragstart', () => { dragSource = { r, c }; });
  tile.addEventListener('dragover', e => e.preventDefault());
  tile.addEventListener('drop', () => { if(dragSource) onTileDrop(r, c); dragSource = null; });

  return tile;
}

function spawnFloatingScore(r, c, points) {
  const tile = tileDomAt(r, c);
  if(!tile) return;

  const tileRect = tile.getBoundingClientRect();
  const boardRect = boardWrap.getBoundingClientRect();

  const scoreEl = document.createElement('div');
  scoreEl.className = 'floating-score';
  scoreEl.textContent = `+${points}`;

  // position relative to boardWrap
  scoreEl.style.position = 'absolute';
  scoreEl.style.left = `${tileRect.left - boardRect.left + tileRect.width/2 - 12}px`;
  scoreEl.style.top = `${tileRect.top - boardRect.top}px`;

  boardWrap.appendChild(scoreEl);

  setTimeout(() => {
    if(scoreEl.parentElement) scoreEl.parentElement.removeChild(scoreEl);
  }, 800); // animation duration
}

function createBoardInitial(){
  board = [];
  for(let r=0; r<ROWS; r++){
    const row = [];
    for(let c=0; c<COLS; c++) row.push(randomCandyValue());
    board.push(row);
  }
  renderWholeBoard();
  setTimeout(() => resolveMatchesAndCascade(true), 50);
}

function renderWholeBoard(){
  innerBoard.innerHTML = '';
  for(let r=0; r<ROWS; r++){
    for(let c=0; c<COLS; c++){
      innerBoard.appendChild(createTileElement(r, c, board[r][c]));
    }
  }
}

function tileDomAt(r,c){ return innerBoard.querySelector(`.tile[data-r="${r}"][data-c="${c}"]`); }
function areAdjacent(a,b){ return Math.abs(a.r-b.r)+Math.abs(a.c-b.c)===1; }

function swapAndResolve(a,b){
  [board[a.r][a.c], board[b.r][b.c]] = [board[b.r][b.c], board[a.r][a.c]];
  renderWholeBoard();
  const matches = findAllMatches();
  if(matches.length === 0){
    setTimeout(() => {
      [board[a.r][a.c], board[b.r][b.c]] = [board[b.r][b.c], board[a.r][a.c]];
      renderWholeBoard();
      tileDomAt(a.r,a.c)?.classList.add('shake');
      tileDomAt(b.r,b.c)?.classList.add('shake');
      setTimeout(() => {
        tileDomAt(a.r,a.c)?.classList.remove('shake');
        tileDomAt(b.r,b.c)?.classList.remove('shake');
      }, 300);
    }, 160);
  } else resolveMatchesAndCascade(false);
}

function findAllMatches(){
  const matched = [];
  for(let r=0;r<ROWS;r++){
    let runVal=board[r][0], runCount=1;
    for(let c=1;c<COLS;c++){
      if(board[r][c]===runVal) runCount++;
      else {
        if(runCount>=3) for(let k=0;k<runCount;k++) matched.push({r, c:c-1-k});
        runVal=board[r][c]; runCount=1;
      }
    }
    if(runCount>=3) for(let k=0;k<runCount;k++) matched.push({r, c:COLS-1-k});
  }
  for(let c=0;c<COLS;c++){
    let runVal=board[0][c], runCount=1;
    for(let r=1;r<ROWS;r++){
      if(board[r][c]===runVal) runCount++;
      else{
        if(runCount>=3) for(let k=0;k<runCount;k++) matched.push({r:r-1-k,c});
        runVal=board[r][c]; runCount=1;
      }
    }
    if(runCount>=3) for(let k=0;k<runCount;k++) matched.push({r:ROWS-1-k,c});
  }
  const seen = new Set(), unique = [];
  for(const m of matched){
    const key = `${m.r},${m.c}`;
    if(!seen.has(key)){seen.add(key); unique.push(m);}
  }
  return unique;
}

function resolveMatchesAndCascade(initialFlag){
  const matches = findAllMatches();
  if(matches.length === 0) return;

  // Add animation
  matches.forEach(pos => tileDomAt(pos.r, pos.c)?.classList.add('matching'));

  setTimeout(() => {
    const matchedValues = [];

    matches.forEach(pos => {
      const val = board[pos.r][pos.c];
      matchedValues.push(val);

      score += 10;
      spawnFloatingScore(pos.r, pos.c, 10);
      board[pos.r][pos.c] = null;
    });

    // ðŸ‘‡ Swish and Match move handling
    if(mode === 'Swish and Match'){
      const bonusCount = matchedValues.filter(v => v === 9).length;
      if(bonusCount > 0){
        // Add moves equal to number of bonus candies
        movesLeft += bonusCount
		bonusSound.currentTime = 0; // rewind to start
        bonusSound.play();
      } else {
        // Deduct 1 move if no bonus candies in the match
        movesLeft--;
      }
    }

    // Hurry Hurry: add 10s every 150 score
    if(mode === 'Hurry Hurry'){
      const scoreBonus = Math.floor(score / 150) * 10;
      const previousBonus = Math.floor((score - matches.length*10) / 150) * 10;
      timerValue += (scoreBonus - previousBonus); 
    }

    updateHUD();
    collapseAndRefill();
setTimeout(() => {
  resolveMatchesAndCascade(false);

  // Check for possible moves
  if (!hasPossibleMoves()) {
    showShuffleOverlay(1200); // show overlay
    setTimeout(() => shuffleBoard(), 300); // shuffle after short delay
  }
}, 120);
	
  }, 400);
}


function collapseAndRefill(){
  for(let c=0;c<COLS;c++){
    const stack=[];
    for(let r=ROWS-1;r>=0;r--) if(board[r][c]!=null) stack.push(board[r][c]);
    while(stack.length<ROWS) stack.push(randomCandyValue());
    for(let r=ROWS-1,i=0;r>=0;r--,i++) board[r][c]=stack[i];
  }
  renderWholeBoard();
}

// Update your onTileClick function to handle persistent glow
function onTileClick(r, c){
  const clickedTile = tileDomAt(r, c);

  if(firstSelection){
    if(firstSelection.r===r && firstSelection.c===c){
      firstSelection=null;
      clickedTile.classList.remove('selected'); // remove glow if unselecting
      return;
    }

    if(areAdjacent(firstSelection,{r,c})){
      swapAndResolve(firstSelection,{r,c});
     // Check if either tile is bonus
	const valA = board[firstSelection.r][firstSelection.c];
	const valB = board[r][c];
	const isBonusSwap = (valA === 9 || valB === 9);
      updateHUD();

      // Remove glow after attempting match
      tileDomAt(firstSelection.r, firstSelection.c)?.classList.remove('selected');
      clickedTile.classList.remove('selected');
    }else {
      // Invalid non-adjacent selection: vibrate both tiles
      const tileA = tileDomAt(firstSelection.r, firstSelection.c);
      const tileB = tileDomAt(r, c);
      tileA?.classList.add('shake');
      tileB?.classList.add('shake');
      setTimeout(() => {
        tileA?.classList.remove('shake');
        tileB?.classList.remove('shake');
      }, 250);
    }	
    firstSelection=null;
  } else {
    firstSelection={r,c};
    clickedTile.classList.add('selected'); // keep glow when selected
  }
}

function onTileDrop(r, c) {
  if (dragSource) {
    if (areAdjacent(dragSource, { r, c })) {
      swapAndResolve(dragSource, { r, c });
	  const valA = board[dragSource.r][dragSource.c];
	  const valB = board[r][c];
	  const isBonusSwap = (valA === 9 || valB === 9);
      updateHUD();
    } else {
      // Invalid drag: vibrate both tiles
      const tileA = tileDomAt(dragSource.r, dragSource.c);
      const tileB = tileDomAt(r, c);
      tileA?.classList.add('shake');
      tileB?.classList.add('shake');
      setTimeout(() => {
        tileA?.classList.remove('shake');
        tileB?.classList.remove('shake');
      }, 250);
    }
  }
  dragSource = null;
}
function updateHUD(){
  scoreDisplay.textContent = `Score: ${score}`;

  if(mode==='Hurry Hurry'){
    const minutes = Math.floor(timerValue / 60);
    const seconds = timerValue % 60;
    timerDisplay.textContent = `Time: ${minutes}:${seconds.toString().padStart(2,'0')}`;
  }
  else if(mode==='Swish and Match') timerDisplay.textContent = `Moves: ${movesLeft}`;
  else if(mode==='Dizzy Dizzy'){
    timerDisplay.textContent = ''; // ðŸ‘ˆ hide moves/timer in Dizzy
  }
  else {
    timerDisplay.textContent = '';
  }
}

function startTimer(){
  clearInterval(timerInterval);
  if(mode==='Hurry Hurry') timerValue=120;
  else timerValue=999;
  timerInterval=setInterval(()=>{
    if(mode==='Hurry Hurry'){
      timerValue--;
      updateHUD();
      if(timerValue<=0){clearInterval(timerInterval); alert('Time\'s up!'); showMenu();}
    }
  },1000);
}

function startDizzy(){
  clearInterval(dizzyInterval);
  dizzyInterval=setInterval(()=>{
    for(let r=0;r<ROWS;r++){
      for(let c=0;c<COLS;c++){
        if(Math.random()<0.08){
          board[r][c]=randomCandyValue();
          const t=tileDomAt(r,c);
          if(t){
            t.classList.add('matching');
            setTimeout(()=>{ t.classList.remove('matching'); renderWholeBoard(); }, 300);
          }
        }
      }
    }
  }, 2000);
}

function showMenu(){
  stopMusic();
  mainMenu.style.display='flex';
  gameContainer.style.display='none';
  musicPlayerBox.style.display='none';
  clearInterval(timerInterval);
  clearInterval(dizzyInterval);
}

function startGame(selectedMode){
  startMusic();
  mode = selectedMode;
  score = 0; movesLeft = 20; firstSelection=null;
  mainMenu.style.display='none';
  gameContainer.style.display='block';
  musicPlayerBox.style.display='block';
  createBoardInitial();
  updateHUD();
  if(mode==='Hurry Hurry') startTimer();
  else if(mode==='Dizzy Dizzy') startDizzy();
}

document.getElementById('classicBtn').onclick = ()=>startGame('Classic');
document.getElementById('hurryBtn').onclick = ()=>startGame('Hurry Hurry');
document.getElementById('dizzyBtn').onclick = ()=>startGame('Dizzy Dizzy');
document.getElementById('swishBtn').onclick = ()=>startGame('Swish and Match');
document.getElementById('backButton').onclick = ()=>showMenu();
document.getElementById('leaderBtn').onclick = ()=>alert('Leaderboard not implemented yet.');


const songs = [
  { title: "Butterfly's Dream", file: "Butterflys Dream.mp3" },
  { title: "Curious", file: "Curious.mp3" },
  { title: "Dating Myself", file: "Dating Myself.mp3" },
  { title: "DDANG!", file: "DDANG!.mp3" },
  { title: "Dopamine", file: "Dopamine.mp3" },
  { title: "Dream of Girls", file: "Dream of Girls.mp3" },
  { title: "From The Seed Called Hey Whats Up", file: "From The Seed Called Hey Whats Up.mp3" },
  { title: "Good Feeling", file: "Good Feeling.mp3" },
  { title: "Moshi Moshi EN ver.", file: "Moshi Moshi EN ver..mp3" },
  { title: "Moshi Moshi JP ver.", file: "Moshi Moshi JP ver..mp3" },
  { title: "Poppin", file: "Poppin.mp3" },
  { title: "See you in my dream (ê¿ˆì—ì„œ ë˜ ë§Œë‚˜)", file: "See you in my dream (ê¿ˆì—ì„œ ë˜ ë§Œë‚˜).mp3" },
  { title: "Shaking My Head", file: "Shaking My Head.mp3" },
  { title: "Spring Rain", file: "Spring Rain.mp3" },
  { title: "Superwoman", file: "Superwoman.mp3" },
  { title: "Swicy", file: "SWICY.mp3" },
  { title: "Watchu Need", file: "Watchu Need.mp3" }
];


let currentSongIndex = 0;
let isPlaying = false;
const audio = new Audio();

const volumeSlider = document.getElementById("volumeSlider");
if (volumeSlider) {
  // set initial audio volume from slider (0-100 -> 0.0-1.0)
  audio.volume = +volumeSlider.value / 100;

  // sync bonus SFX initial volume if present
  if (window.bonusSound) window.bonusSound.volume = audio.volume;

  // update volumes in real time
  volumeSlider.addEventListener("input", (e) => {
    const vol = +e.target.value / 100;
    audio.volume = vol;
    if (window.bonusSound) window.bonusSound.volume = vol;
  });
}


const playBtn = document.getElementById("playBtn");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const progressBar = document.getElementById("progressBar");
const songTitle = document.getElementById("songTitle");
const songList = document.getElementById("songList");

function loadSong(index, autoplay=false) {
  currentSongIndex = index;
  audio.src = songs[index].file;
  songTitle.textContent = songs[index].title;
  if (autoplay) playSong();
}

function playSong() {
  audio.play();
  isPlaying = true;
  playBtn.innerHTML = '<i class="bi bi-pause-fill"></i>';
}

function pauseSong() {
  audio.pause();
  isPlaying = false;
  playBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
}

function nextSong() {
  loadSong((currentSongIndex + 1) % songs.length, true);
}
function prevSong() {
  loadSong((currentSongIndex - 1 + songs.length) % songs.length, true);
}

playBtn.onclick = () => isPlaying ? pauseSong() : playSong();
nextBtn.onclick = nextSong;
prevBtn.onclick = prevSong;

audio.addEventListener("timeupdate", () => {
  const progress = (audio.currentTime / audio.duration) * 100;
  progressBar.style.width = `${progress}%`;
});

audio.addEventListener("ended", nextSong);

// build dropup list
songs.forEach((s, idx) => {
  const li = document.createElement("li");
  const btn = document.createElement("button");
  btn.className = "dropdown-item";
  btn.textContent = s.title;
  btn.onclick = () => loadSong(idx, true);
  li.appendChild(btn);
  songList.appendChild(li);
});

// random autoplay when "game starts"
function startMusic() {
  const randomIndex = Math.floor(Math.random() * songs.length);
  loadSong(randomIndex, true);
}

// stop music when "back" clicked
function stopMusic() {
  audio.pause();
  audio.currentTime = 0;
  isPlaying = false;
  playBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
}
/*

//Music Player 
const musicList = [
  {src: "sounds/song1.mp3", title: "Candy Beats 1"},
  {src: "sounds/song2.mp3", title: "Candy Beats 2"},
  {src: "sounds/song3.mp3", title: "Candy Beats 3"}
];

let currentTrackIndex = 0;
const audioPlayer = document.getElementById("audioPlayer");
const playPauseBtn = document.getElementById("playPauseBtn");
const nextBtn = document.getElementById("nextBtn");
const prevBtn = document.getElementById("prevBtn");
const musicTitle = document.getElementById("trackInfo");
const progressBar = document.getElementById("progress");
let isPlaying = false;

// --- Load Track ---
function loadTrack(index) {
  currentTrackIndex = index;
  audioPlayer.src = musicList[currentTrackIndex].src;
  musicTitle.textContent = musicList[currentTrackIndex].title;
}

// --- Play / Pause ---
function togglePlayPause() {
  if (isPlaying) {
    audioPlayer.pause();
    playPauseBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
  } else {
    audioPlayer.play();
    playPauseBtn.innerHTML = '<i class="bi bi-pause-fill"></i>';
  }
  isPlaying = !isPlaying;
}

// --- Next / Prev ---
function playNext() {
  currentTrackIndex = (currentTrackIndex + 1) % musicList.length;
  loadTrack(currentTrackIndex);
  audioPlayer.play();
  isPlaying = true;
  playPauseBtn.innerHTML = '<i class="bi bi-pause-fill"></i>';
}

function playPrev() {
  currentTrackIndex = (currentTrackIndex - 1 + musicList.length) % musicList.length;
  loadTrack(currentTrackIndex);
  audioPlayer.play();
  isPlaying = true;
  playPauseBtn.innerHTML = '<i class="bi bi-pause-fill"></i>';
}

// --- Progress Bar ---
audioPlayer.addEventListener("timeupdate", () => {
  if (audioPlayer.duration) {
    const percent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
    progressBar.style.width = percent + "%";
  }
});

// --- Auto Next Track ---
audioPlayer.addEventListener("ended", playNext);

// --- Button Events ---
playPauseBtn.onclick = togglePlayPause;
nextBtn.onclick = playNext;
prevBtn.onclick = playPrev;

// --- Initialize ---
loadTrack(currentTrackIndex);*/
</script>

</body>
</html>
